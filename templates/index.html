<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Calorie Estimator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-theme-bg-color, #000000);
            color: var(--tg-theme-text-color, #ffffff);
            height: 100vh;
            overflow: hidden;
        }
        .camera-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .camera-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            border: 2px solid white;
            border-radius: 20px;
            pointer-events: none;
        }
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        .header h1 {
            margin: 0;
            font-size: 18px;
            color: white;
        }
        #result {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
        }
        .language-content {
            height: 100%;
        }
        .capture-button {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 35px;
            z-index: 2;
        }
        .capture-button::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border-radius: 30px;
            border: 2px solid #000;
        }
    </style>
</head>
<body>
    <!-- English content -->
    <div id="en" class="language-content">
        <div class="header">
            <h1>Point camera at food</h1>
        </div>
        <div class="camera-container">
            <video id="camera-view" autoplay playsinline></video>
            <div class="camera-frame"></div>
            <button class="capture-button" id="capture-button"></button>
        </div>
        <div id="result"></div>
    </div>

    <!-- Russian content -->
    <div id="ru" class="language-content" style="display: none;">
        <div class="header">
            <h1>Наведите камеру на еду</h1>
        </div>
        <div class="camera-container">
            <video id="camera-view-ru" autoplay playsinline></video>
            <div class="camera-frame"></div>
            <button class="capture-button" id="capture-button-ru"></button>
        </div>
        <div id="result-ru"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // Get language from Telegram WebApp
        const userLanguage = tg.initDataUnsafe?.user?.language_code || 'en';
        
        // Show content based on language
        const enContent = document.getElementById('en');
        const ruContent = document.getElementById('ru');
        if (userLanguage === 'ru') {
            enContent.style.display = 'none';
            ruContent.style.display = 'block';
        }

        // Camera setup
        async function setupCamera(videoElement) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });
                videoElement.srcObject = stream;
            } catch (err) {
                console.error('Error accessing camera:', err);
            }
        }

        // Setup for both languages
        const videoEn = document.getElementById('camera-view');
        const videoRu = document.getElementById('camera-view-ru');
        const captureEn = document.getElementById('capture-button');
        const captureRu = document.getElementById('capture-button-ru');
        const resultEn = document.getElementById('result');
        const resultRu = document.getElementById('result-ru');

        // Initialize camera for active language
        if (userLanguage === 'ru') {
            setupCamera(videoRu);
        } else {
            setupCamera(videoEn);
        }

        function captureImage(video, result, isRussian) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg');
            processImage(imageData, result, isRussian);
        }

        function setupCaptureButton(button, video, result, isRussian) {
            button.addEventListener('click', () => {
                captureImage(video, result, isRussian);
            });
        }

        setupCaptureButton(captureEn, videoEn, resultEn, false);
        setupCaptureButton(captureRu, videoRu, resultRu, true);

        function processImage(imageData, resultElement, isRussian) {
            fetch('/process-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    image: imageData,
                    language: isRussian ? 'ru' : 'en'
                })
            })
            .then(response => response.json())
            .then(data => {
                resultElement.style.display = 'block';
                if (isRussian) {
                    resultElement.innerHTML = `
                        <h3>Результаты:</h3>
                        <p>Примерное количество калорий: ${data.calories}</p>
                        <p>Тип еды: ${data.food_type}</p>
                        <p>Уверенность: ${data.confidence}</p>
                    `;
                } else {
                    resultElement.innerHTML = `
                        <h3>Results:</h3>
                        <p>Estimated calories: ${data.calories}</p>
                        <p>Food type: ${data.food_type}</p>
                        <p>Confidence: ${data.confidence}</p>
                    `;
                }
                tg.MainButton.setText(isRussian ? 'Готово' : 'Done');
                tg.MainButton.show();
            })
            .catch(error => {
                resultElement.style.display = 'block';
                resultElement.innerHTML = `<p style="color: red;">${isRussian ? 'Ошибка: ' : 'Error: '}${error.message}</p>`;
            });
        }

        tg.MainButton.onClick(() => {
            tg.close();
        });
    </script>
</body>
</html> 